App4Sea=App4Sea||{},App4Sea.KML=function(){"use strict";var my={};let ynd=0;var title="";function repeat_kml_kmz_calls(url,id){var str;url.toLowerCase().endsWith("kmz")?(console.log("readAndAddFeatures kmz element: "+url),ajaxKMZ(url,id,unzipFromBlob(readAndAddFeatures,id))):(console.log("readAndAddFeatures non-kmz element: "+url),ajaxKMZ(url,id,readAndAddFeatures))}function ajaxKMZ(url,id,callback){console.log("ajaxKMZ: "+url),qwest.get(url,null,{responseType:"blob",cache:!0,timeout:2e3,headers:{crossOrigin:"anonymous"}}).then(function(xhr,response){console.log("ajaxKMZ OK: "+url);let str=url.toLowerCase();if(str.endsWith("kml")&&"object"==typeof response){let extendedCallback=function(str1,id1,callb){return function(e){let text=e.srcElement.result;console.log(text),callb(text,str1,id1)}};console.log(response);let reader=new FileReader;reader.addEventListener("loadend",extendedCallback(str,id,callback),{passive:!0}),reader.readAsBinaryString(response)}else callback(response,str,id)}).catch(function(e,xhr){console.log("ajaxKMZ Error: "+e+": Url: "+url+", id: "+id)}).complete(function(){})}function unzipFromBlob(callback,id){return function unzip(blob){zip.createReader(new zip.BlobReader(blob),function(reader){reader.getEntries(function(entries){console.log("Got entries: "+entries.length);for(let ind=0;ind<entries.length;ind++){let extendedCallback=function(str1,id1,callb){return function(text){callb(text,str1,id1,entries)}},str=entries[ind].filename.toLowerCase();entries[ind].getData(new zip.TextWriter,extendedCallback(str,id,callback),function(current,total){})}})},function(error){console.log("unzipFromBlob Error: "+error)})}}zip.workerScriptsPath="static/js/",my.loadKml=function(url){var vector;return console.log("loadKml: "+url),new ol.layer.Vector({source:new ol.source.Vector({url:url,crossOrigin:"anonymous",format:new ol.format.KML({extractStyles:!0,extractAttributes:!0,showPointNames:!1})})})},my.loadKmlKmz=function(url,id,name){console.log("loadKmz: "+id+" from "+url),title=name,repeat_kml_kmz_calls(url,id)};let readAndAddFeatures=function(text,name,id,entries){console.log("readAndAddFeatures >>>> "+name+" from file "+id);let str=name.toLowerCase();if(str.endsWith("kml")){let listFilesNested=parseKmlText(name,text,id,entries);0===listFilesNested.length&&addKMLFeatures(text,str,id),console.log("listFilesNested are "+listFilesNested.length),listFilesNested.forEach(function(el){console.log("readAndAddFeatures ----------"),repeat_kml_kmz_calls(el,id)})}console.log("readAndAddFeatures <<<<")};function addKMLFeatures(text,name,id){if(console.log(">>> addKMLFeatures: "+name),name.endsWith("kml")){var vect=loadKmlText(text,id,name);App4Sea.OpenLayers.layers.push({id:id,vector:vect}),console.log("Cached layers now are "+App4Sea.OpenLayers.layers.length),App4Sea.OpenLayers.Map.addLayer(vect),console.log("addKMLFeatures: "+id+" in file "+name+" DONE")}console.log("<<< addKMLFeatures")}function loadKmlText(text,id,name){console.log("loadKmlText: "+name);var formatter=new ol.format.KML({extractStyles:!0,extractAttributes:!0,showPointNames:!1}),proj=formatter.readProjection(text);null!==proj&&console.log("Projection: "+proj.wb);var kml_features=formatter.readFeatures(text,{dataProjection:App4Sea.prefProj,featureProjection:App4Sea.prefViewProj});console.log("kml_features are: "+kml_features.length);var vector=new ol.layer.Vector({source:new ol.source.Vector({crossOrigin:"anonymous",format:formatter})});return vector.getSource().addFeatures(kml_features),vector}function getStyleEntry(newId,parentId,node){return{type:node.nodeName,id:node.id,newId:newId,parentId:parentId,node:node,value:node.innerHTML}}function addStyleMap(parentId,node){var newID=parentId+"-"+node.id,newStyleMap;switch(node.nodeName){case"StyleMap":newStyleMap=getStyleEntry(newID,parentId,node),App4Sea.OpenLayers.styleMaps.push(newStyleMap);break;case"Style":newStyleMap=getStyleEntry(newID,parentId,node),App4Sea.OpenLayers.styleMaps.push(newStyleMap),newID=App4Sea.OpenLayers.styleMaps.length}return newID}function addChild(text,data,tree,parNode,disabled,icon){var newNode={state:{closed:!0,checkbox_disabled:!1,disabled:disabled},icon:icon,text:text,data:data,selected:!0,children:!1},retVal=tree.jstree(!0).create_node(parNode,newNode,"last",!1,!1);return console.log("Adding "+text+" to tree under "+parNode+" returned "+retVal),retVal}function parseKmlText(path,text,id,entries){var oParser,oDOM=(new DOMParser).parseFromString(text,"text/xml"),links=oDOM.querySelectorAll("NetworkLink Link href"),urls=oDOM.querySelectorAll("NetworkLink Url href"),canAnimate=!1,gol=oDOM.querySelectorAll("GroundOverlay Icon href"),golw=[],golb=[],gole=[],goll=[],count=0;gol.length>0?(canAnimate=!0,0===(golw=oDOM.querySelectorAll("GroundOverlay TimeStamp when")).length?(golb=oDOM.querySelectorAll("GroundOverlay TimeSpan begin"),gole=oDOM.querySelectorAll("GroundOverlay TimeSpan end"),golw=[]):(golb=[],gole=[]),App4Sea.Animation.AniData=[gol,golw,golb,gole,goll]):App4Sea.Animation.AniData=[null,null,null,null,null];var kml=oDOM.querySelector("kml");function getName(children,defaultName){for(var ind=0;ind<children.length;ind++)if("name"===children[ind].nodeName||"atom:name"===children[ind].nodeName)return children[ind].innerHTML;return defaultName}function addOverlay(overlay,id){var href=overlay.querySelector("Icon href"),url;if(href&&(url=href.innerHTML),"ScreenOverlay"===overlay.nodeName){if(console.log("ScreenOverlay: "+url),url){var name,nameIs,name;(name=overlay.querySelector("name"))&&(nameIs=name.innerHTML);var overlayXY=overlay.querySelector("overlayXY"),screenXY=overlay.querySelector("screenXY"),rotationXY=overlay.querySelector("rotationXY"),size=overlay.querySelector("size");function GetValUnit(val,unitin){var valout=val;return valout="fraction"===unitin?100*val+"%":"pixels"===unitin?val+"px":"?"}$("#imgLegend").src=url}}else{if("PhotoOverlay"===overlay.nodeName)return void console.log("PhotoOverlay: "+url);{console.log("GroundOverlay: "+url),url=url.replaceAll(/&amp;/,"&");var west=parseFloat(overlay.querySelector("west").innerHTML),south=parseFloat(overlay.querySelector("south").innerHTML),east=parseFloat(overlay.querySelector("east").innerHTML),north=parseFloat(overlay.querySelector("north").innerHTML),imageExtent=ol.proj.transformExtent([west,south,east,north],App4Sea.prefProj,App4Sea.prefViewProj),nameIs,name;function loadImageFromKmz(entry,ext1,nam){let image=new ol.layer.Image({name:nam}),extendedCallback=function(ex,im){return function(data){console.log(" Extent: "+ex),im.src=App4Sea.Utils.loadImageFromBlob(data,"","",ex),im.extent=ex}};return entry.getData(new zip.BlobWriter("text/plain"),extendedCallback(ext1,image)),image}function findIn(filesInKmz,url,ext,nm){for(let ind=0;ind<filesInKmz.length;ind++)if(filesInKmz[ind].filename===url)return loadImageFromKmz(filesInKmz[ind],ext,nm);return console.log("Didn't find file in kmz: "+nm),null}let image;console.log("GroundOverlay: W:"+west+" S:"+south+" E:"+east+" N:"+north+" Pro:"+App4Sea.prefProj+" ViewProj:"+App4Sea.prefViewProj),(name=overlay.querySelector("name"))&&(nameIs=name.innerHTML),entries&&entries.length>0&&!url.startsWith("http")?(console.log("Getting image from kmz: "+url),image=findIn(entries,url,imageExtent,nameIs)):(console.log("Getting image from http: "+url),image=new ol.layer.Image({name:nameIs,source:new ol.source.ImageStatic({url:url,crossOrigin:"anonymous",imageExtent:imageExtent})})),image&&(App4Sea.OpenLayers.layers.push({id:id,vector:image}),console.log("Added image. Cached layers now are "+App4Sea.OpenLayers.layers.length),App4Sea.OpenLayers.Map.addLayer(image))}}}function listChildren(id,children){for(var cind=0;cind<children.length;cind++){var child=children[cind],newId;if("name"===child.nodeName||"atom:name"===child.nodeName)console.log("Name item not handled");else if("description"===child.nodeName){var description=child;""!==description.innerHTML&&(newId=addChild("Description",description.innerHTML,$("#TreeMenu"),id,!1,"icons/description.png"))}else if("author"===child.nodeName||"atom:author"===child.nodeName){for(var author=child,authText="<p>",aind=0;aind<author.children.length;aind++)0!==aind&&(authText+="<br/>"),authText+=author.children[aind].innerHTML;newId=addChild("Author",authText+="</p>",$("#TreeMenu"),id,!1,"icons/author.png")}else if("Folder"===child.nodeName||"Document"===child.nodeName)newId=addChild(getName(child.children,child.nodeName),child.innerHTML,$("#TreeMenu"),id,!0,"icons/folder.png");else if("Camera"===child.nodeName)console.log("Camera item not handled");else if("Placemark"===child.nodeName)newId=addChild(getName(child.children,child.nodeName),child.innerHTML,$("#TreeMenu"),id,!0,"icons/placemark.png");else if("GroundOverlay"===child.nodeName||"PhotoOverlay"===child.nodeName||"ScreenOverlay"===child.nodeName){addOverlay(child,newId=addChild(getName(child.children,child.nodeName),child.innerHTML,$("#TreeMenu"),id,!1,"icons/overlay.png"));for(var href="",hind=0;hind<child.children.length;hind++){var str=child.children[hind].localName;if("Icon"===(str=str.substr(0,4))){href=child.children[hind].children[0].innerHTML;break}}"GroundOverlay"===child.nodeName&&href===gol[count].innerHTML&&(goll[count]=newId,count+=1)}else"StyleMap"===child.nodeName||"Style"===child.nodeName?newId=addStyleMap(id,child):"TimeSpan"===child.nodeName?console.log(child.nodeName+" item not handled"):"TimeStamp"===child.nodeName?console.log(child.nodeName+" item not handled"):"Link"===child.nodeName||"atom:link"===child.nodeName||"NetworkLink"===child.nodeName||"open"===child.nodeName||"href"===child.nodeName||"visibility"===child.nodeName||"refreshMode"===child.nodeName||"refreshInterval"===child.nodeName||"ExtendedData"===child.nodeName||"Icon"===child.nodeName||"LatLonBox"===child.nodeName||"MultiGeometry"===child.nodeName||"gx:Tour"===child.nodeName||"gx:Playlist"===child.nodeName||"Schema"===child.nodeName||"SimpleField"===child.nodeName||"LineString"===child.nodeName||"Point"===child.nodeName||"Snippet"===child.nodeName||"Region"===child.nodeName||"key"===child.nodeName||"styleUrl"===child.nodeName||"Pair"===child.nodeName||"BalloonStyle"===child.nodeName||"text"===child.nodeName||"LabelStyle"===child.nodeName||"PolyStyle"===child.nodeName||"LineStyle"===child.nodeName||"ListStyle"===child.nodeName||"gx:IconStackStyle"===child.nodeName||"IconStyle"===child.nodeName?console.log(child.nodeName+" item not handled"):console.log("Not handling "+child.nodeName);if(child.children&&child.children.length>0){for(var predecessors=[],par=child.parentNode;par;)predecessors.push(par),par=par.parentNode;predecessors&&predecessors.length<4&&listChildren(newId,child.children)}}}kml&&(listChildren(id,kml.children),canAnimate&&App4Sea.Animation.Animate(path,title));var files=Array.prototype.slice.call(links).map(function(el){return el.textContent});return 0===links.length&&0!==urls.length&&(files=Array.prototype.slice.call(urls).map(function(el){return el.textContent})),console.log("NetworkLink files: "+files.length),files}return my}(App4Sea.KML||{});